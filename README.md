# Goal
checking best option to add Spring support for attribute ```version``` in HTTP Accept header. 

It must support [Semantic versioning](http://semver.org/), see [jsemver](https://github.com/zafarkhaja/jsemver) for a java implementation library


# run
mvn test

# Context
Spring support for HTTP Accept Header versioning is in this form
```http
Accept: application/vnd.uk.gov.hmcts.test+json-1.0.1+json
```
there is a need for supporting:
```http
Accept: application/vnd.uk.gov.hmcts.test+json;version=1.0.1
```
where version should be able to also use semver expressions like:
```http
Accept: application/vnd.uk.gov.hmcts.test+json; version="^1.0.1"
```
Namig convention for HMCTS applications should be:
```html
application/vnd.uk.gov.hmcts.<micro-service-name>.<domain-object-name>.<...?>
```

# Some conclusions/solutions:

1.	Get accept header in one controller and run the private function needed for the specific version

       This is the ugliest one
```java
public String version(@RequestHeader(value = "Accept", required = false) String acceptHeader,
                      NativeWebRequest request) throws HttpMediaTypeNotAcceptableException {
                      …
                      // use match and switch on results to methods representing needed version
                      match(acceptHeader, request.getNativeRequest(HttpServletRequest.class))   
                      …
}

private String match(String acceptHeader, HttpServletRequest request) {
      logger.info(request.getRequestURI()+ " called with Accept:" + acceptHeader);
      Matcher matcher = pattern.matcher(acceptHeader);
      if (matcher.find())
             return matchingVersion(matcher.group(1), new String[] { "1.0.1", "1.3.1", "1.3.4", "2.5.0" });
      return "no match";
}

private String matchingVersion(String version, String[] listOfVersionsToMatchTo) {
      List<Version> toMatch = Arrays.asList(listOfVersionsToMatchTo).stream()
                                    .map(x -> Version.valueOf(x)).collect(Collectors.toList());

      for (Iterator<Version> it = toMatch.iterator(); it.hasNext(); )
        if (!it.next().satisfies(version))
            it.remove();

      logger.info("Satisfying list: "+ toMatch);

      return toMatch.toString();
}
```

2.	Pull Spring repo and add version capability to ```MimeType```, that includes adding ```getVersion()``` and change ```isCompatibleWith()``` -> this one is triggered/used from the dispatcher. Probably few other comparison methods should be updated to regard version. Now only charset and weight are considered as parameters

       I reckon this is preferred, enhancing spring and skipping all kind of ugly hacks

3.	Add custom annotation for version based method running

       Looks good, haven’t tried it yet but still looks like a bit of a hack to build support for this as custom annotations when this is should be a standard implementation:
       
       https://www-stackoverflow-info.blogspot.co.uk/2016/02/how-to-manage-rest-api-versioning-with.html
       https://stackoverflow.com/questions/20655614/request-mapping-using-headers-in-spring-mvc

# Deprecation of APIs or API endpoints
Added an annotation named `@APIDeprecated` for classes and methods that add warning headers to the responses generated by the API.

A typical usage would be to add the @APIDeprecated annotation to a method as in the following example.

```
    @RequestMapping("/deprecated")
    @APIDeprecated(name = "Deprecated Endpoint",
            date = "01/06/2018",
            link = "https://artifactory.reform.hmcts.net/artifactory/ccdata-local/case-data-store-api/",
            note = "Just a note, upgrade your client code!!!")
    public String deprecated() {
        return "Greetings from deprecated Class Controller!";
    }
```
The annotation has the attributes that are used for forming a `Warning` header. 
- `name` for friendly name of the endpoint, 
- `expireDate` for the date which the endpoint will cease to serve, 
- `docLink` for the details of documentation regarding the API updates
- `note` for optional notes to the clients

A sample of the Warning header is as follows:
```
warning →The UserProfileEndpoint is deprecated and will be removed by 20/09/2017. Please see https://artifactory.reform.hmcts.net/artifactory/ccdata-local/case-data-store-api/ for details. Just note that
``` 

It is possible to add the `@APIDeprecated` annotation on top of a `@Controller` class to deprecate all the endpoints served by that `@Controller` at once.
``` 
@RestController
@APIDeprecated(name = "Deprecated API set",
        expireDate = "30/09/2018",
        docLink = "https://artifactory.reform.hmcts.net/artifactory/ccdata-local/case-data-store-api/",
        note = "Just a note, upgrade your client code!!!")
public class DeprecatedClassController {

    @RequestMapping("/depclass")
    public String deprecated() {
        return "Greetings from deprecated Class Controller!";
    }

}
``` 